<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Editor - PDF Pro Suite</title>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #1a1a1a;
            padding: 12px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 500;
            color: #00ff88;
        }
        
        .back-btn {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }
        
        .main {
            display: flex;
            flex: 1;
            height: calc(100vh - 50px);
        }
        
        .sidebar {
            width: 300px;
            background: #141414;
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
        }
        
        .upload-section {
            margin-bottom: 30px;
        }
        
        .upload-box {
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            background: #1a1a1a;
            transition: all 0.3s;
        }
        
        .upload-box:hover {
            border-color: #00ff88;
            background: #1e1e1e;
        }
        
        .upload-box.dragover {
            border-color: #00ff88;
            background: #002a1a;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
            opacity: 0.7;
        }
        
        .viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
        }
        
        .controls {
            background: #1a1a1a;
            padding: 12px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: auto;
            background: #222;
            position: relative;
        }
        
        .pdf-canvas {
            border: 1px solid #555;
            border-radius: 4px;
            margin: 0 auto 20px;
            background: white;
            cursor: crosshair;
            position: relative;
        }
        
        .editing-tools {
            margin-top: 20px;
        }
        
        .tool-group {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .tool-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: #00ff88;
            font-size: 14px;
        }
        
        .tool-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #222;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #333;
            border-color: #555;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: #00ff88; 
            color: #000; 
            border-color: #00ff88;
        }
        
        .btn-primary:hover { 
            background: #00cc70;
            border-color: #00cc70;
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
        }
        
        .btn-active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }
        
        .text-input {
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 8px;
            color: white;
            font-size: 12px;
            margin: 5px 0;
            width: 100%;
        }
        
        .color-input {
            width: 40px;
            height: 30px;
            border: 1px solid #333;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            background: #222;
            padding: 8px 12px;
            border-radius: 4px;
            text-align: center;
            flex: 1;
        }
        
        .stat-number {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 11px;
            color: #999;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
            color: #ccc;
        }
        
        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }
        
        .placeholder h3 {
            margin-bottom: 10px;
            color: #999;
            font-size: 24px;
        }
        
        .placeholder p {
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: #00ff88;
            color: #000;
        }
        
        .toast.error {
            background: #ff4757;
        }
        
        .toast.info {
            background: #3742fa;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #00ff88;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .annotation {
            position: absolute;
            pointer-events: none;
            font-family: Arial, sans-serif;
        }
        
        .annotation.text {
            color: #000;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .annotation.shape {
            border: 2px solid;
        }
        
        .page-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-input {
            width: 60px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 4px 8px;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>‚úèÔ∏è PDF Editor</h1>
        <a href="../../index.html" class="back-btn">‚Üê Back to Tools</a>
    </header>

    <main class="main">
        <div class="sidebar">
            <div class="upload-section">
                <div class="section-title">Upload PDF File</div>
                <div class="upload-box" id="uploadBox">
                    <span class="upload-icon">üìÑ</span>
                    <div>Drop PDF here or click to browse</div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">Maximum file size: 100MB</div>
                </div>
                <input type="file" id="pdfInput" accept=".pdf" style="display: none">
            </div>

            <div class="editing-tools" id="editingTools" style="display: none;">
                <div class="section-title">PDF Information</div>
                
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalPages">0</div>
                        <div class="stat-label">Pages</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="currentPage">1</div>
                        <div class="stat-label">Current</div>
                    </div>
                </div>

                <div class="tool-group">
                    <div class="tool-title">üìù Text Tools</div>
                    <div class="tool-buttons">
                        <button class="btn btn-small" id="textTool">Add Text</button>
                        <button class="btn btn-small" id="highlightTool">Highlight</button>
                    </div>
                    <input type="text" class="text-input" id="textInput" placeholder="Enter text to add">
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <span style="font-size: 11px;">Color:</span>
                        <input type="color" class="color-input" id="textColor" value="#000000">
                        <span style="font-size: 11px;">Size:</span>
                        <input type="range" id="textSize" min="8" max="48" value="16" style="flex: 1;">
                        <span id="textSizeValue" style="font-size: 11px;">16px</span>
                    </div>
                </div>

                <div class="tool-group">
                    <div class="tool-title">üñºÔ∏è Image Tools</div>
                    <div class="tool-buttons">
                        <button class="btn btn-small" id="imageTool">Add Image</button>
                        <button class="btn btn-small" id="stampTool">Add Stamp</button>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>

                <div class="tool-group">
                    <div class="tool-title">üî∫ Shape Tools</div>
                    <div class="tool-buttons">
                        <button class="btn btn-small" id="rectangleTool">Rectangle</button>
                        <button class="btn btn-small" id="circleTool">Circle</button>
                        <button class="btn btn-small" id="lineTool">Line</button>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <span style="font-size: 11px;">Color:</span>
                        <input type="color" class="color-input" id="shapeColor" value="#ff0000">
                        <span style="font-size: 11px;">Width:</span>
                        <input type="range" id="shapeWidth" min="1" max="10" value="2" style="flex: 1;">
                        <span id="shapeWidthValue" style="font-size: 11px;">2px</span>
                    </div>
                </div>

                <div class="tool-group">
                    <div class="tool-title">üíæ Save & Export</div>
                    <div class="tool-buttons">
                        <button class="btn btn-primary" id="saveBtn" style="width: 100%;">Save Edited PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="viewer">
            <div class="controls" id="controls" style="display: none;">
                <div class="page-navigation">
                    <button class="btn btn-small" id="prevPageBtn" disabled>‚Üê Previous</button>
                    <span style="font-size: 14px;">Page</span>
                    <input type="number" class="page-input" id="pageInput" value="1" min="1">
                    <span style="font-size: 14px;" id="pageTotal">of 1</span>
                    <button class="btn btn-small" id="nextPageBtn" disabled>Next ‚Üí</button>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-small" id="zoomOutBtn">Zoom Out</button>
                    <span style="font-size: 14px;" id="zoomLevel">100%</span>
                    <button class="btn btn-small" id="zoomInBtn">Zoom In</button>
                    <button class="btn btn-small" id="clearAnnotationsBtn">Clear All</button>
                </div>
            </div>

            <div class="content-area">
                <div class="placeholder" id="placeholder">
                    <h3>‚úèÔ∏è PDF Editor</h3>
                    <p>Upload a PDF file to start editing with text, images, and shapes</p>
                    <div style="font-size: 14px; color: #777; margin-top: 20px;">
                        ‚úÖ Add text and annotations<br>
                        ‚úÖ Insert images and stamps<br>
                        ‚úÖ Draw shapes and lines<br>
                        ‚úÖ Save edited PDF document
                    </div>
                </div>
                <div class="loading" id="loading">
                    <div>Loading PDF for editing...</div>
                </div>
                <div id="canvasContainer" style="display: none;">
                    <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        class PDFEditor {
            constructor() {
                this.pdfDoc = null;
                this.pdfLibDoc = null;
                this.totalPages = 0;
                this.currentPageNum = 1;
                this.zoom = 1.0;
                this.currentTool = null;
                this.annotations = [];
                this.isDrawing = false;
                this.startX = 0;
                this.startY = 0;

                this.uploadBox = document.getElementById('uploadBox');
                this.pdfInput = document.getElementById('pdfInput');
                this.editingTools = document.getElementById('editingTools');
                this.controls = document.getElementById('controls');
                this.placeholder = document.getElementById('placeholder');
                this.loading = document.getElementById('loading');
                this.canvasContainer = document.getElementById('canvasContainer');
                this.canvas = document.getElementById('pdfCanvas');
                this.ctx = this.canvas.getContext('2d');

                this.setupEvents();
            }

            setupEvents() {
                this.uploadBox.addEventListener('click', () => this.pdfInput.click());
                this.pdfInput.addEventListener('change', (e) => this.loadPDF(e.target.files[0]));

                this.setupDragDrop();
                this.setupToolEvents();
                this.setupCanvasEvents();
                this.setupNavigationEvents();
            }

            setupDragDrop() {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

                this.uploadBox.addEventListener('dragover', () => {
                    this.uploadBox.classList.add('dragover');
                });

                this.uploadBox.addEventListener('dragleave', () => {
                    this.uploadBox.classList.remove('dragover');
                });

                this.uploadBox.addEventListener('drop', (e) => {
                    this.uploadBox.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    const pdfFile = files.find(f => f.type === 'application/pdf');
                    if (pdfFile) this.loadPDF(pdfFile);
                });
            }

            setupToolEvents() {
                // Tool selection
                document.getElementById('textTool').addEventListener('click', () => this.selectTool('text'));
                document.getElementById('highlightTool').addEventListener('click', () => this.selectTool('highlight'));
                document.getElementById('imageTool').addEventListener('click', () => this.selectImageTool());
                document.getElementById('stampTool').addEventListener('click', () => this.selectTool('stamp'));
                document.getElementById('rectangleTool').addEventListener('click', () => this.selectTool('rectangle'));
                document.getElementById('circleTool').addEventListener('click', () => this.selectTool('circle'));
                document.getElementById('lineTool').addEventListener('click', () => this.selectTool('line'));

                // Tool settings
                document.getElementById('textSize').addEventListener('input', (e) => {
                    document.getElementById('textSizeValue').textContent = e.target.value + 'px';
                });

                document.getElementById('shapeWidth').addEventListener('input', (e) => {
                    document.getElementById('shapeWidthValue').textContent = e.target.value + 'px';
                });

                // Image input
                document.getElementById('imageInput').addEventListener('change', (e) => {
                    this.handleImageUpload(e.target.files[0]);
                });

                // Save button
                document.getElementById('saveBtn').addEventListener('click', () => this.saveEditedPDF());

                // Clear annotations
                document.getElementById('clearAnnotationsBtn').addEventListener('click', () => this.clearAnnotations());
            }

            setupCanvasEvents() {
                this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
            }

            setupNavigationEvents() {
                document.getElementById('prevPageBtn').addEventListener('click', () => this.previousPage());
                document.getElementById('nextPageBtn').addEventListener('click', () => this.nextPage());
                document.getElementById('pageInput').addEventListener('change', (e) => this.goToPage(parseInt(e.target.value)));
                document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
            }

            async loadPDF(file) {
                if (!file || file.type !== 'application/pdf') {
                    this.showToast('Please select a valid PDF file', 'error');
                    return;
                }

                try {
                    this.showToast('Loading PDF...', 'info');
                    this.placeholder.style.display = 'none';
                    this.loading.style.display = 'block';

                    const arrayBuffer = await file.arrayBuffer();
                    const typedArray = new Uint8Array(arrayBuffer);
                    
                    // Load with PDF.js for rendering
                    this.pdfDoc = await pdfjsLib.getDocument({
                        data: typedArray,
                        cMapUrl: 'https://unpkg.com/pdfjs-dist@3.11.174/cmaps/',
                        cMapPacked: true
                    }).promise;

                    // Load with PDF-lib for editing
                    this.pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    this.totalPages = this.pdfDoc.numPages;
                    this.currentPageNum = 1;
                    this.annotations = [];

                    this.updateUI();
                    await this.renderPage(1);

                    this.loading.style.display = 'none';
                    this.canvasContainer.style.display = 'block';
                    this.controls.style.display = 'flex';
                    this.editingTools.style.display = 'block';

                    this.showToast(`PDF loaded: ${this.totalPages} pages`, 'success');
                } catch (error) {
                    console.error('PDF loading error:', error);
                    this.showToast('Failed to load PDF', 'error');
                    this.loading.style.display = 'none';
                    this.placeholder.style.display = 'flex';
                }
            }

            async renderPage(pageNum) {
                try {
                    const page = await this.pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: this.zoom });

                    this.canvas.width = viewport.width;
                    this.canvas.height = viewport.height;

                    await page.render({
                        canvasContext: this.ctx,
                        viewport: viewport
                    }).promise;

                    this.renderAnnotations();
                } catch (error) {
                    console.error('Page rendering error:', error);
                    this.showToast('Failed to render page', 'error');
                }
            }

            renderAnnotations() {
                // Re-draw annotations on the current page
                const pageAnnotations = this.annotations.filter(ann => ann.page === this.currentPageNum);
                
                pageAnnotations.forEach(annotation => {
                    this.ctx.save();
                    
                    switch (annotation.type) {
                        case 'text':
                            this.ctx.fillStyle = annotation.color;
                            this.ctx.font = `${annotation.size}px Arial`;
                            this.ctx.fillText(annotation.text, annotation.x, annotation.y);
                            break;
                            
                        case 'highlight':
                            this.ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
                            this.ctx.fillRect(annotation.x, annotation.y - 20, annotation.width, 25);
                            break;
                            
                        case 'rectangle':
                            this.ctx.strokeStyle = annotation.color;
                            this.ctx.lineWidth = annotation.width;
                            this.ctx.strokeRect(annotation.x, annotation.y, annotation.w, annotation.h);
                            break;
                            
                        case 'circle':
                            this.ctx.strokeStyle = annotation.color;
                            this.ctx.lineWidth = annotation.width;
                            this.ctx.beginPath();
                            this.ctx.arc(annotation.x + annotation.w/2, annotation.y + annotation.h/2, 
                                       Math.abs(annotation.w)/2, 0, 2 * Math.PI);
                            this.ctx.stroke();
                            break;
                            
                        case 'line':
                            this.ctx.strokeStyle = annotation.color;
                            this.ctx.lineWidth = annotation.width;
                            this.ctx.beginPath();
                            this.ctx.moveTo(annotation.x, annotation.y);
                            this.ctx.lineTo(annotation.x + annotation.w, annotation.y + annotation.h);
                            this.ctx.stroke();
                            break;
                    }
                    
                    this.ctx.restore();
                });
            }

            selectTool(tool) {
                this.currentTool = tool;
                
                // Update button states
                document.querySelectorAll('.tool-buttons .btn').forEach(btn => {
                    btn.classList.remove('btn-active');
                });
                
                const toolButtons = {
                    'text': 'textTool',
                    'highlight': 'highlightTool',
                    'stamp': 'stampTool',
                    'rectangle': 'rectangleTool',
                    'circle': 'circleTool',
                    'line': 'lineTool'
                };
                
                if (toolButtons[tool]) {
                    document.getElementById(toolButtons[tool]).classList.add('btn-active');
                }
                
                this.canvas.style.cursor = tool === 'text' ? 'text' : 'crosshair';
            }

            selectImageTool() {
                document.getElementById('imageInput').click();
            }

            handleImageUpload(file) {
                if (!file || !file.type.startsWith('image/')) {
                    this.showToast('Please select a valid image file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.currentTool = 'image';
                        this.pendingImage = img;
                        this.canvas.style.cursor = 'crosshair';
                        this.showToast('Click on the PDF to place the image', 'info');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            handleCanvasClick(e) {
                if (!this.currentTool) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                switch (this.currentTool) {
                    case 'text':
                        this.addTextAnnotation(x, y);
                        break;
                    case 'image':
                        this.addImageAnnotation(x, y);
                        break;
                }
            }

            handleMouseDown(e) {
                if (!this.currentTool || ['text', 'image'].includes(this.currentTool)) return;

                this.isDrawing = true;
                const rect = this.canvas.getBoundingClientRect();
                this.startX = e.clientX - rect.left;
                this.startY = e.clientY - rect.top;
            }

            handleMouseMove(e) {
                if (!this.isDrawing) return;

                const rect = this.canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                // Redraw the page and existing annotations
                this.renderPage(this.currentPageNum);

                // Draw preview of current shape
                this.ctx.save();
                this.ctx.strokeStyle = document.getElementById('shapeColor').value;
                this.ctx.lineWidth = document.getElementById('shapeWidth').value;

                switch (this.currentTool) {
                    case 'rectangle':
                        this.ctx.strokeRect(this.startX, this.startY, 
                                          currentX - this.startX, currentY - this.startY);
                        break;
                    case 'circle':
                        this.ctx.beginPath();
                        const radius = Math.abs(currentX - this.startX) / 2;
                        this.ctx.arc(this.startX + (currentX - this.startX)/2, 
                                   this.startY + (currentY - this.startY)/2, radius, 0, 2 * Math.PI);
                        this.ctx.stroke();
                        break;
                    case 'line':
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.startX, this.startY);
                        this.ctx.lineTo(currentX, currentY);
                        this.ctx.stroke();
                        break;
                }
                this.ctx.restore();
            }

            handleMouseUp(e) {
                if (!this.isDrawing) return;

                this.isDrawing = false;
                const rect = this.canvas.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;

                this.addShapeAnnotation(this.startX, this.startY, endX - this.startX, endY - this.startY);
            }

            addTextAnnotation(x, y) {
                const text = document.getElementById('textInput').value;
                if (!text.trim()) {
                    this.showToast('Please enter text to add', 'error');
                    return;
                }

                const annotation = {
                    type: 'text',
                    page: this.currentPageNum,
                    x: x,
                    y: y,
                    text: text,
                    color: document.getElementById('textColor').value,
                    size: parseInt(document.getElementById('textSize').value)
                };

                this.annotations.push(annotation);
                this.renderAnnotations();
                this.showToast('Text added', 'success');
            }

            addImageAnnotation(x, y) {
                if (!this.pendingImage) return;

                // Scale image to reasonable size
                const maxSize = 100;
                let width = this.pendingImage.width;
                let height = this.pendingImage.height;

                if (width > maxSize || height > maxSize) {
                    const ratio = Math.min(maxSize / width, maxSize / height);
                    width *= ratio;
                    height *= ratio;
                }

                this.ctx.drawImage(this.pendingImage, x, y, width, height);

                const annotation = {
                    type: 'image',
                    page: this.currentPageNum,
                    x: x,
                    y: y,
                    width: width,
                    height: height,
                    imageData: this.pendingImage.src
                };

                this.annotations.push(annotation);
                this.pendingImage = null;
                this.currentTool = null;
                this.canvas.style.cursor = 'default';
                this.showToast('Image added', 'success');
            }

            addShapeAnnotation(x, y, w, h) {
                const annotation = {
                    type: this.currentTool,
                    page: this.currentPageNum,
                    x: x,
                    y: y,
                    w: w,
                    h: h,
                    color: document.getElementById('shapeColor').value,
                    width: parseInt(document.getElementById('shapeWidth').value)
                };

                this.annotations.push(annotation);
                this.showToast(`${this.currentTool} added`, 'success');
            }

            clearAnnotations() {
                this.annotations = this.annotations.filter(ann => ann.page !== this.currentPageNum);
                this.renderPage(this.currentPageNum);
                this.showToast('Page annotations cleared', 'success');
            }

            async saveEditedPDF() {
                try {
                    this.showToast('Saving edited PDF...', 'info');

                    // For simplicity, we'll create a new PDF with the rendered canvas images
                    const newPdfDoc = await PDFLib.PDFDocument.create();

                    for (let pageNum = 1; pageNum <= this.totalPages; pageNum++) {
                        // Render each page with annotations
                        await this.renderPage(pageNum);

                        // Convert canvas to image
                        const imageData = this.canvas.toDataURL('image/png');
                        const imageBytes = this.dataURLToBytes(imageData);
                        const image = await newPdfDoc.embedPng(imageBytes);

                        const page = newPdfDoc.addPage([this.canvas.width, this.canvas.height]);
                        page.drawImage(image, {
                            x: 0,
                            y: 0,
                            width: this.canvas.width,
                            height: this.canvas.height
                        });
                    }

                    const pdfBytes = await newPdfDoc.save();
                    this.downloadPDF(pdfBytes, 'edited-document.pdf');

                    // Return to current page
                    await this.renderPage(this.currentPageNum);

                    this.showToast('PDF saved successfully', 'success');
                } catch (error) {
                    console.error('Save error:', error);
                    this.showToast('Failed to save PDF', 'error');
                }
            }

            dataURLToBytes(dataURL) {
                const base64 = dataURL.split(',')[1];
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes;
            }

            downloadPDF(pdfBytes, filename) {
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async previousPage() {
                if (this.currentPageNum > 1) {
                    this.currentPageNum--;
                    await this.renderPage(this.currentPageNum);
                    this.updatePageNavigation();
                }
            }

            async nextPage() {
                if (this.currentPageNum < this.totalPages) {
                    this.currentPageNum++;
                    await this.renderPage(this.currentPageNum);
                    this.updatePageNavigation();
                }
            }

            async goToPage(pageNum) {
                if (pageNum >= 1 && pageNum <= this.totalPages) {
                    this.currentPageNum = pageNum;
                    await this.renderPage(this.currentPageNum);
                    this.updatePageNavigation();
                }
            }

            zoomIn() {
                this.zoom = Math.min(this.zoom * 1.2, 3.0);
                this.renderPage(this.currentPageNum);
                this.updateZoomDisplay();
            }

            zoomOut() {
                this.zoom = Math.max(this.zoom / 1.2, 0.5);
                this.renderPage(this.currentPageNum);
                this.updateZoomDisplay();
            }

            updatePageNavigation() {
                document.getElementById('currentPage').textContent = this.currentPageNum;
                document.getElementById('pageInput').value = this.currentPageNum;
                document.getElementById('prevPageBtn').disabled = this.currentPageNum === 1;
                document.getElementById('nextPageBtn').disabled = this.currentPageNum === this.totalPages;
            }

            updateZoomDisplay() {
                document.getElementById('zoomLevel').textContent = Math.round(this.zoom * 100) + '%';
            }

            updateUI() {
                document.getElementById('totalPages').textContent = this.totalPages;
                document.getElementById('pageTotal').textContent = `of ${this.totalPages}`;
                document.getElementById('pageInput').max = this.totalPages;
                this.updatePageNavigation();
                this.updateZoomDisplay();
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }
        }

        // Initialize the editor
        document.addEventListener('DOMContentLoaded', () => {
            new PDFEditor();
        });
    </script>
</body>
</html>